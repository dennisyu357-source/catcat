<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‰ä»–å’ªçš„éŸ³ä¹ä¹‹æ—… - å‡çº§ç‰ˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #fff; /* åˆå§‹èƒŒæ™¯ */
            overflow: hidden;
            font-family: 'Zcool KuaiLe', sans-serif, cursive;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 0.3s;
        }

        .title {
            font-size: 40px;
            color: #333;
            text-shadow: 2px 2px 0px #eee;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        .subtitle {
            font-size: 18px;
            color: #555;
            margin-bottom: 40px;
            background: rgba(255,255,255,0.9);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .score-board {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            color: #333;
            background: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 10px;
            pointer-events: none;
        }

        /* æŠ¤ç›¾UI */
        .shield-status {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 20px;
            color: #4a90e2;
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            gap: 5px;
            pointer-events: none;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-screen {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="start-screen">
            <div class="title">ğŸ¸ å‰ä»–å’ªçš„éŸ³ä¹ä¹‹æ—… ğŸµ</div>
            <div class="subtitle">ç‚¹å‡»è·³è·ƒ / ç©ºä¸­å†æ¬¡ç‚¹å‡»äºŒæ®µè·³</div>
            <div style="font-size: 20px; color: #ff6b6b; animation: blink 1s infinite;">ç‚¹å‡»å±å¹•å¼€å§‹</div>
        </div>
        <div id="game-over-screen" style="display: none;">
            <div class="title" style="color:#ff4757">å“å‘€ï¼èµ°éŸ³äº†ï¼</div>
            <div class="subtitle" id="final-score">å¾—åˆ†: 0</div>
            <div style="font-size: 20px; color: #333;">ç‚¹å‡»ä»»æ„å¤„é‡è¯•</div>
        </div>
    </div>

    <div class="score-board">âœ¨ <span id="score">0</span></div>
    <div class="shield-status" id="shield-ui">ğŸ›¡ï¸ æŠ¤ç›¾æ¿€æ´»</div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // --- æ¸¸æˆè®¾ç½®ä¸åˆå§‹åŒ– ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiLayer = document.getElementById('ui-layer');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const scoreEl = document.getElementById('score');
        const finalScoreEl = document.getElementById('final-score');
        const shieldUi = document.getElementById('shield-ui');

        let width, height;
        let frameId;
        let score = 0;
        
        // æ—¶é—´æ§åˆ¶ (Delta Time)
        let lastTime = 0;
        let speedMultiplier = 1; // éšæ—¶é—´å¢åŠ éš¾åº¦

        let state = 'START'; // START, PLAYING, GAMEOVER

        // ç‰©ç†å¸¸æ•° (åŸºäº60FPSæ ‡å‡†åŒ–çš„æ•°å€¼)
        const BASE_SPEED = 300; // åƒç´ /ç§’
        const GRAVITY = 1800;   // åƒç´ /ç§’^2
        const JUMP_FORCE = -750;
        const GROUND_H = 100;

        // è§’è‰²ï¼šå‰ä»–å’ª
        const mimi = {
            x: 50,
            y: 0,
            w: 60,
            h: 60,
            dy: 0, // å‚ç›´é€Ÿåº¦
            grounded: false,
            jumpCount: 0, // äºŒæ®µè·³è®¡æ•°
            maxJumps: 2,
            hasShield: false,
            phrase: "", 
            phraseTimer: 0,
            invincibleTimer: 0 // å—ä¼¤åçš„çŸ­æš‚æ— æ•Œ
        };

        // æ¸¸æˆå¯¹è±¡
        let obstacles = [];
        let items = []; // æ˜Ÿæ˜Ÿå’ŒæŠ¤ç›¾
        let particles = [];
        let bgElements = []; // äº‘æœµã€å±±è„‰

        // éŸ³é¢‘ä¸Šä¸‹æ–‡
        let audioCtx;
        // Cå¤§è°ƒäº”å£° + é«˜å…«åº¦
        const scale = [261.6, 293.6, 329.6, 392.0, 440.0, 523.2, 587.3, 659.2]; 
        let noteIndex = 0;

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            if (state === 'START') {
                mimi.y = height - GROUND_H - mimi.h;
                mimi.x = width * 0.15;
            }
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // æ’­æ”¾å‰ä»–éŸ³ï¼ˆåŠ å…¥éšæœºè½»å¾®å¤±è°ï¼Œæ›´æœ‰æ‰‹æ„Ÿï¼‰
        function playGuitarNote(isDoubleJump) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'triangle'; // ä¸‰è§’æ³¢æ¥è¿‘å‰ä»–/é•¿ç¬›
            
            // éŸ³é«˜é€‰æ‹©
            let freq = scale[noteIndex % scale.length];
            if (isDoubleJump) freq *= 1.5; // äºŒæ®µè·³éŸ³é«˜æ›´é«˜
            
            osc.frequency.value = freq;
            noteIndex++;

            // éŸ³é‡åŒ…ç»œ
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.2, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(now + 0.6);
        }

        function playSoundEffect(type) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            if (type === 'collect') { // å®
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, now);
                osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
            } else if (type === 'shield') { // æŠ¤ç›¾éŸ³æ•ˆ
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.linearRampToValueAtTime(660, now + 0.2);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
            } else if (type === 'crash') { // æ’å‡»
                osc.type = 'sawtooth';
                osc.frequency.value = 100;
                osc.frequency.linearRampToValueAtTime(20, now + 0.4);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
            } else if (type === 'break_shield') { // ç¢ç›¾
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
            }

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(now + 0.5);
        }

        // æ‰‹ç»˜é£æ ¼æŠ–åŠ¨
        function j(val, intensity = 1.5) {
            return val + (Math.random() - 0.5) * intensity;
        }

        // --- ç»˜åˆ¶å‡½æ•° ---

        function drawMimi(ctx, x, y, w, h) {
            ctx.save();
            ctx.translate(x + w/2, y + h/2);
            
            // å—ä¼¤é—ªçƒ
            if (mimi.invincibleTimer > 0 && Math.floor(Date.now()/50)%2===0) {
                ctx.globalAlpha = 0.5;
            }

            // è·‘æ­¥/è·³è·ƒå§¿æ€
            if (state === 'PLAYING' && mimi.grounded) {
                ctx.rotate(Math.sin(Date.now() / 80) * 0.15);
            } else {
                // äºŒæ®µè·³ç¿»æ»š
                if (mimi.jumpCount === 2) {
                    ctx.rotate(Date.now() / 100); 
                } else {
                    ctx.rotate(-0.1); // æ™®é€šè·³è·ƒå‰å€¾
                }
            }

            // æŠ¤ç›¾å…‰ç¯
            if (mimi.hasShield) {
                ctx.beginPath();
                ctx.arc(0, 0, w/2 + 10, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(74, 144, 226, ${0.5 + Math.sin(Date.now()/200)*0.2})`;
                ctx.lineWidth = 4;
                ctx.stroke();
            }

            // èº«ä½“
            ctx.beginPath();
            ctx.fillStyle = '#fff';
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 3;
            ctx.ellipse(0, 5, w/2, h/2 - 5, 0, 0, Math.PI * 2);
            ctx.fill(); ctx.stroke();

            // è€³æœµ
            const drawEar = (direction) => {
                ctx.beginPath();
                const d = direction; // -1 or 1
                ctx.moveTo(j(d*20), j(-20));
                ctx.lineTo(j(d*25), j(-35));
                ctx.lineTo(j(d*10), j(-25));
                ctx.fillStyle = '#fff'; ctx.fill(); ctx.stroke();
            };
            drawEar(-1); drawEar(1);

            // è¡¨æƒ…
            ctx.fillStyle = '#000';
            if (state === 'GAMEOVER') {
                // æ™•å€’çœ¼ x x
                ctx.font = "20px Arial";
                ctx.fillText("x", -20, 0);
                ctx.fillText("x", 10, 0);
            } else {
                // è±†è±†çœ¼
                ctx.beginPath(); ctx.arc(j(-12), j(-5), 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(j(12), j(-5), 3, 0, Math.PI*2); ctx.fill();
            }

            // è…®çº¢
            ctx.fillStyle = '#ffb7b2';
            ctx.globalAlpha = 0.8;
            ctx.beginPath(); ctx.arc(j(-18), j(2), 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(j(18), j(2), 5, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;

            // å‰ä»–
            ctx.save();
            ctx.rotate(-0.3);
            ctx.fillStyle = '#ffafc0';
            ctx.strokeStyle = '#222';
            ctx.beginPath(); ctx.arc(8, 18, 14, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#555';
            ctx.fillRect(13, 13, 28, 7); // ç´é¢ˆ
            ctx.fillStyle = '#fff'; // ç´å¼¦
            ctx.fillRect(15, 15, 20, 1);
            ctx.restore();

            // æ‰‹
            ctx.strokeStyle = '#222';
            ctx.beginPath(); ctx.arc(-12, 12, 6, 0, Math.PI); ctx.stroke();
            ctx.beginPath(); ctx.arc(12, 14, 6, 0, Math.PI); ctx.stroke();

            ctx.restore();
        }

        // èƒŒæ™¯ç»˜åˆ¶ (è§†å·®æ»šåŠ¨)
        function drawBackground(ctx) {
            // å¤©ç©º
            const grad = ctx.createLinearGradient(0, 0, 0, height);
            grad.addColorStop(0, '#e0f7fa');
            grad.addColorStop(1, '#ffffff');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0, width, height);

            // ç»˜åˆ¶èƒŒæ™¯å…ƒç´ 
            bgElements.forEach(el => {
                ctx.fillStyle = el.type === 'cloud' ? 'rgba(255,255,255,0.8)' : '#dcedc8';
                ctx.beginPath();
                if (el.type === 'cloud') {
                    ctx.arc(el.x, el.y, el.size, 0, Math.PI*2);
                    ctx.arc(el.x + el.size, el.y - el.size*0.5, el.size*0.8, 0, Math.PI*2);
                    ctx.arc(el.x + el.size*2, el.y, el.size*0.9, 0, Math.PI*2);
                } else {
                    // å±±
                    ctx.moveTo(el.x, height - GROUND_H);
                    ctx.lineTo(el.x + el.size, height - GROUND_H - el.size);
                    ctx.lineTo(el.x + el.size*2, height - GROUND_H);
                }
                ctx.fill();
            });
        }

        // --- é€»è¾‘æ›´æ–° (Delta Time) ---
        
        function update(dt) {
            // dt æ˜¯ç§’ä¸ºå•ä½ (ä¾‹å¦‚ 0.016)
            if (state !== 'PLAYING') return;

            // éš¾åº¦éšæ—¶é—´ç¼“æ…¢å¢åŠ 
            speedMultiplier += dt * 0.02;
            const currentSpeed = BASE_SPEED * speedMultiplier;

            // èƒŒæ™¯ç”Ÿæˆ
            if (Math.random() < 0.02) {
                bgElements.push({
                    x: width + 100,
                    y: Math.random() * height * 0.5,
                    size: 30 + Math.random() * 50,
                    speed: 20 + Math.random() * 30, // æ…¢é€Ÿ
                    type: Math.random() > 0.5 ? 'cloud' : 'mountain'
                });
            }

            // èƒŒæ™¯ç§»åŠ¨
            for (let i = bgElements.length - 1; i >= 0; i--) {
                let el = bgElements[i];
                el.x -= el.speed * dt;
                if (el.x < -200) bgElements.splice(i, 1);
            }

            // å’ªçš„ç‰©ç†
            mimi.dy += GRAVITY * dt;
            mimi.y += mimi.dy * dt;

            // åœ°é¢æ£€æµ‹
            if (mimi.y + mimi.h > height - GROUND_H) {
                mimi.y = height - GROUND_H - mimi.h;
                mimi.dy = 0;
                mimi.grounded = true;
                mimi.jumpCount = 0; // é‡ç½®å¤šæ®µè·³
            } else {
                mimi.grounded = false;
            }
            
            // æ— æ•Œæ—¶é—´å€’è®¡æ—¶
            if (mimi.invincibleTimer > 0) mimi.invincibleTimer -= dt;

            // éšœç¢ç‰©ç”Ÿæˆ (èµ°éŸ³ç¬¦)
            // é—´éš”ç”Ÿæˆï¼šè·ç¦»è¶Šè¿œç”Ÿæˆæ¦‚ç‡è¶Šé«˜ï¼Œé¿å…é‡å 
            const lastObs = obstacles[obstacles.length-1];
            let minSafeDist = 400;
            if (!lastObs || (width - lastObs.x > minSafeDist)) {
                if (Math.random() < 0.015 * speedMultiplier) {
                    obstacles.push({
                        x: width,
                        y: height - GROUND_H - 40,
                        w: 30,
                        h: 40,
                        type: 'note'
                    });
                }
            }

            // ç‰©å“ç”Ÿæˆ (æ˜Ÿæ˜Ÿ & æŠ¤ç›¾)
            if (Math.random() < 0.01) {
                const isShield = Math.random() < 0.1; // 10%æ¦‚ç‡å‡ºæŠ¤ç›¾
                items.push({
                    x: width,
                    y: height - GROUND_H - 80 - Math.random() * 120,
                    w: 30,
                    h: 30,
                    type: isShield ? 'shield' : 'star',
                    angle: 0
                });
            }

            // æ›´æ–°éšœç¢ç‰©
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.x -= currentSpeed * dt;

                // ç¢°æ’æ£€æµ‹ (ç¨å¾®ç¼©å°åˆ¤å®šæ¡†)
                const hitMargin = 10;
                if (mimi.invincibleTimer <= 0 &&
                    mimi.x + hitMargin < obs.x + obs.w - hitMargin &&
                    mimi.x + mimi.w - hitMargin > obs.x + hitMargin &&
                    mimi.y + hitMargin < obs.y + obs.h - hitMargin &&
                    mimi.y + mimi.h - hitMargin > obs.y + hitMargin
                ) {
                    if (mimi.hasShield) {
                        // æŠ¤ç›¾ç¢è£‚é€»è¾‘
                        mimi.hasShield = false;
                        mimi.invincibleTimer = 1.0; // æ— æ•Œ1ç§’
                        shieldUi.style.display = 'none';
                        playSoundEffect('break_shield');
                        createParticles(mimi.x, mimi.y, '#4a90e2', 10);
                        mimi.phrase = "å¥½é™©ï¼";
                        mimi.phraseTimer = 60;
                    } else {
                        gameOver();
                    }
                }

                if (obs.x + obs.w < 0) obstacles.splice(i, 1);
            }

            // æ›´æ–°ç‰©å“
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.x -= currentSpeed * dt;
                item.angle += 2 * dt;

                if (
                    mimi.x < item.x + item.w &&
                    mimi.x + mimi.w > item.x &&
                    mimi.y < item.y + item.h &&
                    mimi.y + mimi.h > item.y
                ) {
                    if (item.type === 'star') {
                        score += 10;
                        scoreEl.innerText = score;
                        createParticles(item.x, item.y, '#ffd700', 5);
                        playSoundEffect('collect');
                    } else if (item.type === 'shield') {
                        mimi.hasShield = true;
                        shieldUi.style.display = 'flex';
                        createParticles(item.x, item.y, '#4a90e2', 8);
                        playSoundEffect('shield');
                        mimi.phrase = "å®‰å…¨æ„Ÿï¼";
                        mimi.phraseTimer = 60;
                    }
                    items.splice(i, 1);
                } else if (item.x < -50) {
                    items.splice(i, 1);
                }
            }

            // æ›´æ–°ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx * dt * 60; // Normalize to frames
                p.y += p.vy * dt * 60;
                p.life -= dt * 60;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 30 + Math.random() * 20,
                    color: color
                });
            }
        }

        // ç»˜åˆ¶å¾ªç¯
        function draw() {
            ctx.clearRect(0, 0, width, height);

            drawBackground(ctx);

            // åœ°é¢
            ctx.beginPath();
            ctx.moveTo(0, height - GROUND_H);
            for(let i=0; i<width; i+=20) {
                ctx.lineTo(i, height - GROUND_H + j(0));
            }
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.fillStyle = '#fcfcfc';
            ctx.fill();
            
            // åœ°é¢æè¾¹
            ctx.beginPath();
            ctx.moveTo(0, height - GROUND_H);
            for(let i=0; i<width; i+=20) {
                ctx.lineTo(i, height - GROUND_H + j(0));
            }
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ç»˜åˆ¶éšœç¢ç‰©
            obstacles.forEach(obs => {
                ctx.fillStyle = '#333';
                ctx.font = "36px Arial";
                ctx.fillText("â™©", obs.x, obs.y + 35);
                // æ¶‚é¸¦æ‚çº¿
                ctx.strokeStyle = '#ff4757';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(obs.x - 5, obs.y + 20);
                ctx.lineTo(obs.x + 35, obs.y + 20);
                ctx.moveTo(obs.x - 5, obs.y + 10);
                ctx.lineTo(obs.x + 35, obs.y + 30);
                ctx.stroke();
            });

            // ç»˜åˆ¶ç‰©å“
            items.forEach(item => {
                ctx.save();
                ctx.translate(item.x + item.w/2, item.y + item.h/2);
                ctx.rotate(item.angle);
                if (item.type === 'star') {
                    ctx.fillStyle = '#ffd700';
                    ctx.font = "30px Arial";
                    ctx.fillText("â˜…", -15, 10);
                } else {
                    // æŠ¤ç›¾å›¾æ ‡
                    ctx.fillStyle = '#4a90e2';
                    ctx.font = "26px Arial";
                    ctx.fillText("ğŸ›¡ï¸", -15, 10);
                }
                ctx.restore();
            });

            // ç²’å­
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = Math.max(0, p.life / 40);
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });

            drawMimi(ctx, mimi.x, mimi.y, mimi.w, mimi.h);

            // æ°”æ³¡
            if (mimi.phraseTimer > 0) {
                mimi.phraseTimer--;
                const x = mimi.x + 40;
                const y = mimi.y - 40;
                ctx.save();
                ctx.font = "20px 'Zcool KuaiLe'";
                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                const text = mimi.phrase;
                const tw = ctx.measureText(text).width;
                ctx.beginPath();
                ctx.roundRect(x, y - 20, tw + 20, 30, 10);
                ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#000';
                ctx.fillText(text, x + 10, y + 2);
                // å°ä¸‰è§’
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x+10, y+10); ctx.lineTo(x+10, y-5); ctx.fill(); ctx.stroke();
                ctx.restore();
            }
        }

        function loop(timestamp) {
            // è®¡ç®—Delta Time (ç§’)
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            // é™åˆ¶æœ€å¤§dté˜²æ­¢åˆ‡å±åç¬ç§»
            const safeDt = Math.min(dt, 0.1);

            update(safeDt);
            draw();
            frameId = requestAnimationFrame(loop);
        }

        // --- æ¸¸æˆæ§åˆ¶ ---

        function action() {
            if (state !== 'PLAYING') return;
            
            // åœ°é¢è·³è·ƒ
            if (mimi.grounded) {
                mimi.dy = JUMP_FORCE;
                mimi.grounded = false;
                mimi.jumpCount = 1;
                playGuitarNote(false);
                createParticles(mimi.x + mimi.w/2, mimi.y + mimi.h, '#ddd', 5);
            } 
            // äºŒæ®µè·³
            else if (mimi.jumpCount < mimi.maxJumps) {
                mimi.dy = JUMP_FORCE * 0.9; // äºŒæ®µè·³ç¨å¾®ä½ä¸€ç‚¹
                mimi.jumpCount++;
                playGuitarNote(true);
                createParticles(mimi.x + mimi.w/2, mimi.y + mimi.h, '#ffafc0', 8); // ç²‰è‰²ç²’å­
                
                // æ—‹è½¬åŠ¨ç”»é‡ç½®
                // ç®€å•çš„æ—‹è½¬æ•ˆæœåœ¨drawé‡Œå¤„ç†
            }
        }

        function startGame() {
            initAudio();
            state = 'PLAYING';
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            shieldUi.style.display = 'none';
            document.body.classList.remove('shake-screen');
            
            score = 0;
            scoreEl.innerText = 0;
            speedMultiplier = 1;
            obstacles = [];
            items = [];
            particles = [];
            bgElements = [];
            
            mimi.y = height - GROUND_H - mimi.h;
            mimi.dy = 0;
            mimi.grounded = true;
            mimi.hasShield = false;
            lastTime = performance.now();

            mimi.phrase = "å¥½å§ï¼";
            mimi.phraseTimer = 100;
        }

        function gameOver() {
            state = 'GAMEOVER';
            document.body.classList.add('shake-screen'); // CSSéœ‡åŠ¨
            playSoundEffect('crash');
            
            mimi.phrase = "è®¨åŒä½ ï¼";
            mimi.phraseTimer = 200;
            
            // å¼ºåˆ¶é‡ç»˜ä¸€å¸§ä»¥æ˜¾ç¤ºæ°”æ³¡
            draw();

            setTimeout(() => {
                finalScoreEl.innerText = "å¾—åˆ†: " + score;
                gameOverScreen.style.display = 'block';
            }, 800);
        }

        // è¾“å…¥å¤„ç†
        function handleInput(e) {
            if (state === 'START' || state === 'GAMEOVER') {
                // ç®€å•çš„é˜²è¯¯è§¦
                if (e.type === 'touchstart') {
                    setTimeout(startGame, 100);
                } else {
                    startGame();
                }
            } else {
                action();
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') handleInput(e);
        });

        window.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleInput(e);
        }, {passive: false});

        window.addEventListener('mousedown', handleInput);
        window.addEventListener('resize', resize);

        resize();
        requestAnimationFrame(loop); // å¯åŠ¨å¾ªç¯

    </script>
</body>
</html>
